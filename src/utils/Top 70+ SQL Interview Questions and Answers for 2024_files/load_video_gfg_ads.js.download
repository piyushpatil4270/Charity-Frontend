// Create Iframe for Video player
function createIframe(filename) {
    // Create the iframe element
    var iframe = document.createElement('iframe');
    iframe.id = 'video-iframe';
    iframe.src = 'https://cdnads.geeksforgeeks.org/instream/' + filename;
    iframe.width = '640px';
    iframe.height = '380px';
    iframe.referrerPolicy = "origin";
    iframe.frameBorder = '0'; // Optional: Remove border
    iframe.allowFullscreen = true; // Optional: Allow fullscreen

    // Create a container for the iframe
    var container = document.createElement('div');
    container.id = 'video-iframe-container';
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.justifyContent = 'center'; // Horizontally center
    container.style.alignItems = 'center'; // Vertically center (if container has height)
    container.style.height = '100%'; // Adjust height as needed

    // Append iframe to container
    container.appendChild(iframe);

    return container;
}

try {
    var isInstreamDivExist = document.querySelector("#GFG_AD_InContent_Desktop_728x280");

    // Fetch the video API:
    const url = 'https://apiscript.geeksforgeeks.org/get-post-videos/' + window.post_id + '/';
    fetch(url)
        .then(response => response.json())
        .then(resp => {
            if (resp.length > 0) {
                // Filter videos with a Course Link
                let newResp = resp.filter(curr => curr.course_link != null);
                if (newResp.length > 0) {
                    resp = newResp;
                }

                // Increasing the maxHeight of isInstreamDivExist
                isInstreamDivExist.style.maxHeight = '500px';

                // Create and append the video player iframe
                const videoPlayer = createIframe("video.html");
                const videoIframe = videoPlayer.querySelector('iframe');

                videoIframe.onload = function () {
                    // Post initial data to iframe
                    videoIframe.contentWindow.postMessage({ resp: resp, inView: false }, '*');

                    // Set up Intersection Observer
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            const inView = entry.isIntersecting && entry.intersectionRatio >= 0.5;
                            videoIframe.contentWindow.postMessage({ inView }, '*');

                            // Unobserve after the element is sufficiently visible
                            if (inView) {
                                observer.unobserve(videoPlayer);
                            }
                        });
                    }, {
                        threshold: [0.5]  // 50% visibility threshold
                    });
                    observer.observe(videoPlayer);

                    // Add Horizontal Lines above and below the instream DIV
                    const horizontalLine = document.createElement('hr');
                    horizontalLine.style.cssText = `
                        border: 1px solid var(--recommendation-card-border);
                        width: 100%;
                    `;
                    isInstreamDivExist.insertAdjacentElement('beforebegin', horizontalLine);
                    isInstreamDivExist.insertAdjacentElement('afterend', horizontalLine.cloneNode(true));

                    // Create container for Title and Course link
                    if (resp[0].title || resp[0].course_link) {
                        const videoInfoContainer = document.createElement('div');
                        videoInfoContainer.id = "video-info-container";
                        videoInfoContainer.style.cssText = `
                            display: flex;
                            width: 640px;
                            padding: 0px 10px;
                            align-items: center;
                        `;


                        // Add the Title of the Video Player
                        if (resp[0].title) {
                            const titleHeading = document.createElement('h1');
                            titleHeading.id = "video-info-container-title";
                            titleHeading.innerText = "Video | " + resp[0].title;
                            titleHeading.style.cssText = `
                                text-align: left;
                                color: var(--similar-read-title-color);
                                font-size: 20px;
                                width: ${resp[0].course_link ? '80%' : '100%'};
                            `;

                            // Append Title in container and then container after Video Player
                            videoInfoContainer.appendChild(titleHeading);
                        }

                        // Add the Course Link of the Video Player
                        if (resp[0].course_link) {
                            const courseLink = document.createElement('a');
                            courseLink.id = "video-info-container-course-link";
                            courseLink.href = resp[0].course_link;
                            courseLink.target = '_blank';
                            courseLink.style.cssText = `
                                border: 2px solid var(--recommendation-card-border);
                                border-radius: 12px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                                text-decoration: none;
                                font-size: 15px;
                                width: 20%;
                                transition: border-color 0.3s;
                            `;

                            const linkText = document.createElement('span');
                            linkText.innerHTML = 'Visit Course';
                            linkText.style.color = 'var(--similar-read-title-color)';
                            courseLink.appendChild(linkText);

                            videoInfoContainer.appendChild(courseLink);

                            // Add hover effect using JavaScript
                            courseLink.addEventListener('mouseover', function () {
                                courseLink.style.borderColor = 'var(--similar-read-title-color)';  // Change border color on hover
                            });

                            courseLink.addEventListener('mouseout', function () {
                                courseLink.style.borderColor = 'var(--recommendation-card-border)';  // Revert border color
                            });
                        }

                        videoIframe.insertAdjacentElement('afterend', videoInfoContainer);
                    }
                };

                isInstreamDivExist.appendChild(videoPlayer);
            }
            else {
                console.info("NO INSTREAM VIDEO FOUND ON THIS PAGE");
                isInstreamDivExist.style.minHeight = '0px';
            }
        })
        .catch(error => {
            console.error('There has been a problem with apiscript fetch operation:', error);
            isInstreamDivExist.style.minHeight = '0px'; // Optional: set minHeight if an error occurs
        });
} catch (error) {
    console.error('Unable to load the Video Player, error occured: ', error);
}